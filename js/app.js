function updateScore(tx){tx.executeSql("SELECT SUM(score) sum FROM histories",null,function(tx,result){var sum=result.rows.item(0).sum;scoreElem.innerHTML=sum,scoreProgressBar.style.width=sum/10+"%"})}function renderLog(log){var date=new Date(log.date),dateStr=date.getFullYear()+"-"+(date.getMonth()||12)+"-"+date.getDate();return'<div class="row log"><div class="col-xs-6 date">'+dateStr+'</div><div class="col-xs-6 score">'+(0<log.score?"获得":"扣除")+"积分<strong>"+Math.abs(log.score)+"</strong></div></div>"}function addScore(event){event.preventDefault();var colorEnable="#95a5a6",colorDisable="whitesmoke";submitElem.style.background=colorDisable,submitElem.disabled=!0,db.transaction(function(tx){var date=new Date;tx.executeSql("INSERT INTO histories (date, score) VALUES (?, ?)",[date,selectElem.value],function(tx){setTimeout(function(){submitElem.style.background=colorEnable,submitElem.disabled=!1},1e3),updateScore(tx),logContainer.innerHTML=renderLog({date:date,score:selectElem.value})+logContainer.innerHTML})})}function changeScore(event,select){for(var str=("0"+select.value).slice(-3),spans=document.querySelectorAll(".form-score .number"),i=0,l=str.length;l>i;i++)spans[i].innerHTML=str[i]}var logContainer=document.querySelector("#history .container.logs"),scoreElem=document.querySelector(".score-total strong"),scoreProgressBar=document.querySelector("#scores .progress-bar"),selectElem=document.querySelector(".form-score select"),submitElem=document.querySelector(".form-score button"),db=openDatabase("scoreboard","0.0.1","",1048576);db.transaction(function(tx){function updateRow(item){if(!/^\d+$/.test(item.date)){var date=+new Date(item.date);tx.executeSql("UPDATE histories SET date=? WHERE date=?",[date,item.date])}}tx.executeSql("CREATE TABLE IF NOT EXISTS histories (date, score)"),tx.executeSql("SELECT * FROM histories ORDER BY rowid DESC",null,function(tx,result){for(var logs="",i=0,l=result.rows.length;l>i;i++){var item=result.rows.item(i);logs+=renderLog(item),updateRow(item)}logContainer.innerHTML+=logs}),updateScore(tx)});